#!/usr/bin/make -f
export DH_VERBOSE=1

DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

DESTDIR=$(CURDIR)/debian/ejabberd


%:
	dh $@ --with=systemd


.PHONY: override_dh_auto_configure
override_dh_auto_configure:
	        dh_auto_configure -- --enable-odbc --enable-mysql --enable-pgsql --enable-pam \
			--enable-zlib --enable-iconv --enable-lager --enable-redis --enable-sqlite

.PHONY: override_dh_auto_install
override_dh_auto_install:
	dh_auto_install
	
	# install init script and service file
	install -m 755 $(CURDIR)/ejabberd.init $(CURDIR)/debian/
	install -m 644 $(CURDIR)/ejabberd.service.template $(CURDIR)/debian/ejabberd.service
	
	# ejabberd.yml is generated from the template through debconf
	rm $(DESTDIR)/etc/ejabberd/ejabberd.yml
	install -m 644 ejabberd.yml.example $(DESTDIR)/usr/share/ejabberd/ejabberd.yml.example
	
	# ejabberdctl.cfg goes into /etc/default/
	mv $(DESTDIR)/etc/ejabberd/ejabberdctl.cfg $(DESTDIR)/etc/default/ejabberd
	ln -s ../default/ejabberd $(DESTDIR)/etc/ejabberd/ejabberdctl.cfg
	
	# install ufw profile
	install -m 644 debian/ejabberd.ufw.profile $(DESTDIR)/etc/ufw/applications.d/ejabberd
	
	# remove unnecessary files/folders
	rm $(DESTDIR)/usr/share/doc/ejabberd/COPYING
	find $(DESTDIR) -type d -empty -delete

.PHONY: override_dh_installinit
override_dh_installinit:
	dh_installinit -vR

.PHONY: override_dh_systemd_start
override_dh_systemd_start:
	dh_systemd_start --restart-after-upgrade

.PHONY: override_dh_compress
override_dh_compress:
	dh_compress --exclude=ejabberd.yml

.PHONY: override_dh_installdeb
override_dh_installdeb:
	erlang-depends
	dh_installdeb

.PHONY: override_dh_auto_clean
override_dh_auto_clean:
	rm -f debian/ejabberd.init debian/ejabberd.service ejabberd.init ejabberdctl.example
	dh_auto_clean
	debconf-updatepo
