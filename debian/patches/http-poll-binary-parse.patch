From: Badlop <badlop@process-one.net>
Subject: Fix parsing of binary values in http-poll module (EJAB-1325)
Origin: upstream, https://git.process-one.net/ejabberd/mainline/commit/d87fff1a4c500d9abe3945cbfea792b4eddfa3f2
Bug: https://support.process-one.net/browse/EJAB-1325
Bug-Debian: http://bugs.debian.org/601094

--- a/src/web/ejabberd_http_poll.erl
+++ b/src/web/ejabberd_http_poll.erl
@@ -272,7 +272,13 @@ handle_event(_Event, StateName, StateData) ->
 %%          {stop, Reason, Reply, NewStateData}                    
 %%----------------------------------------------------------------------
 handle_sync_event({send, Packet}, _From, StateName, StateData) ->
-    Output = StateData#state.output ++ [lists:flatten(Packet)],
+    Packet2 = if
+		  is_binary(Packet) ->
+		      binary_to_list(Packet);
+		  true ->
+		      Packet
+	      end,
+    Output = StateData#state.output ++ [lists:flatten(Packet2)],
     Reply = ok,
     {reply, Reply, StateName, StateData#state{output = Output}};
 
