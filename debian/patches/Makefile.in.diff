Description: adjust Makefile.in for Debian packaging
 ejabberd's makefile needs to be altered in order to be compatible to
 Debian's package building process.
Author: Philipp Huebner <debalance@debian.org>

Index: ejabberd/Makefile.in
===================================================================
--- ejabberd.orig/Makefile.in
+++ ejabberd/Makefile.in
@@ -1,4 +1,4 @@
-REBAR = @ESCRIPT@ rebar
+REBAR = rebar
 INSTALL = @INSTALL@
 SED = @SED@
 ERL = @ERL@
@@ -74,26 +74,11 @@ else
   INIT_USER=$(INSTALLUSER)
 endif
 
-all: deps src
+all: src
 
-deps: deps/.got
-
-deps/.got:
-	rm -rf deps/.got
-	rm -rf deps/.built
-	$(REBAR) get-deps && :> deps/.got
-
-deps/.built: deps/.got
-	$(REBAR) compile && :> deps/.built
-
-src: deps/.built
+src:
 	$(REBAR) skip_deps=true compile
 
-update:
-	rm -rf deps/.got
-	rm -rf deps/.built
-	$(REBAR) update-deps && :> deps/.got
-
 xref: all
 	$(REBAR) skip_deps=true xref
 
@@ -106,11 +91,9 @@ edoc:
         'case edoc:application(ejabberd, ".", []) of ok -> halt(0); error -> halt(1) end.'
 
 spec:
-	$(ERL) -noinput +B -pa ebin -pa deps/*/ebin -eval \
+	$(ERL) -noinput +B -pa ebin -eval \
 	'case xml_gen:compile("tools/xmpp_codec.spec") of ok -> halt(0); _ -> halt(1) end.'
 
-DLLs := $(wildcard deps/*/priv/*.so) $(wildcard deps/*/priv/lib/*.so)
-
 install: all
 	#
 	# Configuration files
@@ -135,11 +118,6 @@ install: all
 	# Administration script
 	[ -d $(SBINDIR) ] || $(INSTALL) -d -m 755 $(SBINDIR)
 	$(INSTALL) -m 550 $(G_USER) ejabberdctl.example $(SBINDIR)/ejabberdctl
-	# Elixir binaries
-	[ -d $(BINDIR) ] || $(INSTALL) -d -m 755 $(BINDIR)
-	[ -f deps/elixir/bin/iex ] && $(INSTALL) -m 550 $(G_USER) deps/elixir/bin/iex $(BINDIR)/iex || true
-	[ -f deps/elixir/bin/elixir ] && $(INSTALL) -m 550 $(G_USER) deps/elixir/bin/elixir $(BINDIR)/elixir || true
-	[ -f deps/elixir/bin/mix ] && $(INSTALL) -m 550 $(G_USER) deps/elixir/bin/mix $(BINDIR)/mix || true
 	#
 	# Init script
 	$(SED) -e "s*@ctlscriptpath@*$(SBINDIR)*" \
@@ -151,63 +129,32 @@ install: all
 	$(INSTALL) -d $(BEAMDIR)
 	$(INSTALL) -m 644 ebin/*.app $(BEAMDIR)
 	$(INSTALL) -m 644 ebin/*.beam $(BEAMDIR)
-	$(INSTALL) -m 644 deps/*/ebin/*.app $(BEAMDIR)
-	$(INSTALL) -m 644 deps/*/ebin/*.beam $(BEAMDIR)
-	# Install Elixir and Elixir dependancies
-	-$(INSTALL) -m 644 deps/*/lib/*/ebin/*.app $(BEAMDIR)
-	-$(INSTALL) -m 644 deps/*/lib/*/ebin/*.beam $(BEAMDIR)
 	rm -f $(BEAMDIR)/configure.beam
 	#
 	# ejabberd header files
 	$(INSTALL) -d $(INCLUDEDIR)
 	$(INSTALL) -m 644 include/*.hrl $(INCLUDEDIR)
-	$(INSTALL) -m 644 deps/*/include/*.hrl $(INCLUDEDIR)
 	#
 	# Binary C programs
 	$(INSTALL) -d $(PBINDIR)
 	$(INSTALL) -m 750 $(O_USER) tools/captcha.sh $(PBINDIR)
 	$(INSTALL) -m 750 $(O_USER) tools/joincluster $(PBINDIR)
 	$(INSTALL) -m 750 $(O_USER) tools/leavecluster $(PBINDIR)
-	[ -f deps/p1_pam/priv/bin/epam ] \
-		&& $(INSTALL) -m 750 $(O_USER) deps/p1_pam/priv/bin/epam $(PBINDIR) \
-		|| true
-	#
-	# Binary system libraries
-	$(INSTALL) -d $(SODIR)
-	$(INSTALL) -m 644 $(DLLs) $(SODIR)
-	[ -f $(SODIR)/jiffy.so ] && (cd $(PRIVDIR); ln -s lib/jiffy.so; true) || true
-	[ -f $(SODIR)/sqlite3_drv.so ] && (cd $(PRIVDIR); ln -s lib/sqlite3_drv.so; true) || true
 	#
 	# Translated strings
 	$(INSTALL) -d $(MSGSDIR)
 	$(INSTALL) -m 644 priv/msgs/*.msg $(MSGSDIR)
 	#
-	# Copy lite.sql
-	[ -d deps/sqlite3 ] && $(INSTALL) -d $(SQLDIR) || true
-	[ -d deps/sqlite3 ] && $(INSTALL) -m 644 sql/lite.sql $(SQLDIR) || true
-	#
 	# Spool directory
 	$(INSTALL) -d -m 750 $(O_USER) $(SPOOLDIR)
 	$(CHOWN_COMMAND) -R @INSTALLUSER@ $(SPOOLDIR) >$(CHOWN_OUTPUT)
 	chmod -R 750 $(SPOOLDIR)
 	[ ! -f $(COOKIEFILE) ] || { $(CHOWN_COMMAND) @INSTALLUSER@ $(COOKIEFILE) >$(CHOWN_OUTPUT) ; chmod 400 $(COOKIEFILE) ; }
 	#
-	# ejabberdctl lock directory
-	$(INSTALL) -d -m 750 $(O_USER) $(CTLLOCKDIR)
-	$(CHOWN_COMMAND) -R @INSTALLUSER@ $(CTLLOCKDIR) >$(CHOWN_OUTPUT)
-	chmod -R 750 $(CTLLOCKDIR)
-	#
 	# Log directory
 	$(INSTALL) -d -m 750 $(O_USER) $(LOGDIR)
 	$(CHOWN_COMMAND) -R @INSTALLUSER@ $(LOGDIR) >$(CHOWN_OUTPUT)
 	chmod -R 750 $(LOGDIR)
-	#
-	# Documentation
-	$(INSTALL) -d $(DOCDIR)
-	[ -f doc/guide.html ] \
-		&& $(INSTALL) -m 644 doc/guide.html $(DOCDIR) \
-		|| echo "Documentation not included in sources"
-	$(INSTALL) -m 644 COPYING $(DOCDIR)
 
 uninstall: uninstall-binary
 
@@ -240,8 +187,6 @@ uninstall-all: uninstall-binary
 	rm -rf $(LOGDIR)
 
 clean:
-	rm -rf deps/.got
-	rm -rf deps/.built
 	rm -rf test/*.beam
 	$(REBAR) clean
 
@@ -252,7 +197,6 @@ distclean: clean clean-rel
 	rm -f config.status
 	rm -f config.log
 	rm -rf autom4te.cache
-	rm -rf deps
 	rm -rf ebin
 	rm -f Makefile
 	rm -f vars.config
@@ -267,8 +211,6 @@ TAGS:
 
 Makefile: Makefile.in
 
-deps := $(wildcard deps/*/ebin)
-
 dialyzer/erlang.plt:
 	@mkdir -p dialyzer
 	@dialyzer --build_plt --output_plt dialyzer/erlang.plt \
@@ -277,12 +219,6 @@ dialyzer/erlang.plt:
 	runtime_tools asn1 observer xmerl et gs wx syntax_tools; \
 	status=$$? ; if [ $$status -ne 2 ]; then exit $$status; else exit 0; fi
 
-dialyzer/deps.plt:
-	@mkdir -p dialyzer
-	@dialyzer --build_plt --output_plt dialyzer/deps.plt \
-	-o dialyzer/deps.log $(deps); \
-	status=$$? ; if [ $$status -ne 2 ]; then exit $$status; else exit 0; fi
-
 dialyzer/ejabberd.plt:
 	@mkdir -p dialyzer
 	@dialyzer --build_plt --output_plt dialyzer/ejabberd.plt \
@@ -293,29 +229,20 @@ erlang_plt: dialyzer/erlang.plt
 	@dialyzer --plt dialyzer/erlang.plt --check_plt -o dialyzer/erlang.log; \
 	status=$$? ; if [ $$status -ne 2 ]; then exit $$status; else exit 0; fi
 
-deps_plt: dialyzer/deps.plt
-	@dialyzer --plt dialyzer/deps.plt --check_plt -o dialyzer/deps.log; \
-	status=$$? ; if [ $$status -ne 2 ]; then exit $$status; else exit 0; fi
-
 ejabberd_plt: dialyzer/ejabberd.plt
 	@dialyzer --plt dialyzer/ejabberd.plt --check_plt -o dialyzer/ejabberd.log; \
 	status=$$? ; if [ $$status -ne 2 ]; then exit $$status; else exit 0; fi
 
-dialyzer: erlang_plt deps_plt ejabberd_plt
+dialyzer: erlang_plt ejabberd_plt
 	@dialyzer --plts dialyzer/*.plt --no_check_plt \
 	--get_warnings -o dialyzer/error.log ebin; \
 	status=$$? ; if [ $$status -ne 2 ]; then exit $$status; else exit 0; fi
 
 test:
-	@echo "************************** NOTICE ***************************************"
-	@cat test/README
-	@echo "*************************************************************************"
-	@cd priv && ln -sf ../sql
-	$(REBAR) skip_deps=true ct
 
 quicktest:
 	$(REBAR) skip_deps=true ct suites=elixir
 
 .PHONY: src edoc dialyzer Makefile TAGS clean clean-rel distclean rel \
-	install uninstall uninstall-binary uninstall-all translations deps test spec \
-	quicktest erlang_plt deps_plt ejabberd_plt
+	install uninstall uninstall-binary uninstall-all translations test spec \
+	quicktest erlang_plt ejabberd_plt
