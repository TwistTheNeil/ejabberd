#! /bin/sh
# postinst script for ejabberd
#
# see: dh_installdeb(1)

set -e

CONFIG_SOURCE=/usr/share/ejabberd/ejabberd.cfg
CONFIG_TARGET=/etc/ejabberd/ejabberd.cfg
TEMPFILE=$(mktemp)

. /usr/share/debconf/confmodule

setup_ejabberd()
{
    # Ejabberd config dir may contain sensitive data, so makig it readable only by ejabberd user.
    chown ejabberd:ejabberd /etc/ejabberd
    chmod 700 /etc/ejabberd

    # The sane is for /var/lib/ejabberd, where the users database is located.
    install -m 700 -d /var/lib/ejabberd
    chown -R ejabberd:ejabberd /var/lib/ejabberd

    # Ejabberd logs should be readable by users in adm group (see also logrotate script).
    install -o ejabberd -g adm -m 750 -d /var/log/ejabberd

    # Moving certivicate from /etc/ssl/certs to /etc/ejabberd (see bug #368414).
    cd /etc/ssl/certs
    if [ -f ejabberd.pem ] && [ ! -z $2 ] && dpkg --compare-versions "$2" lt-nl "1.1.1-3"
    then
	echo "Moving ejabberd.pem from /etc/ssl/certs to /etc/ejabberd..."
	rm -f $(openssl x509 -noout -hash < ejabberd.pem).0
	mv ejabberd.pem /etc/ejabberd
	echo "Replacing /etc/ejabberd/ejabberd.pem for /etc/ssl/certs/ejabberd.pem in the config file..."
	sed -i -e 's:/etc/ssl/certs/ejabberd.pem:/etc/ejabberd/ejabberd.pem:g' /etc/ejabberd/ejabberd.cfg
    fi

    # Making /etc/ejabberd/ejabberd.pem if it does not exist.
    ( cd /etc/ejabberd
    if [ -f ejabberd.pem ]
    then
	echo "You already have /etc/ejabberd/ejabberd.pem"
	chown ejabberd:ejabberd ejabberd.pem
	chmod 600 ejabberd.pem
    else
	HOSTNAME=$(hostname -s)
	DOMAINNAME=$(hostname -d)
	openssl req -new -x509 -days 365 -nodes -out ejabberd.pem \
		    -keyout ejabberd.pem > /dev/null 2>&1 <<+++
.
.
.
$DOMAINNAME
$HOSTNAME
ejabberd
root@$HOSTNAME.$DOMAINNAME
+++
    fi
    chown ejabberd:ejabberd /etc/ejabberd/ejabberd.pem
    chmod 600 /etc/ejabberd/ejabberd.pem
    )

    db_get ejabberd/hostname
    HOST="$RET"
    db_get ejabberd/user
    USER="$RET"
    db_get ejabberd/password
    PASSWD="$RET"
    sed -e "s/__USER__/$USER/g ; s/__HOSTNAME__/$HOST/g" $CONFIG_SOURCE >$TEMPFILE
    ucf --three-way --debconf-ok $TEMPFILE $CONFIG_TARGET
    db_stop

    # Making ejabberd config readable only by ejabberd user.
    chown ejabberd:ejabberd $CONFIG_TARGET
    chmod 600 $CONFIG_TARGET
}

register_admin()
{
    if [ -n "$USER" -a -n "$PASSWD" ]; then
	echo -n "Waiting for ejabberd to register admin user."
	cnt=0
	flag=1
	while ! ejabberdctl vhost "$HOST" registered-users >/dev/null ; do
	    echo -n "."
	    cnt=`expr $cnt + 1`
	    if [ $cnt -gt 60 ] ; then
		echo
		echo "Can't register admin user \"$USER@$HOST\"."
		echo -n "Probably ejabberd is configured for serving another hostname."
		flag=0
		break
	    fi
	    sleep 1
	done

	echo
	if [ $flag -eq 1 ] ; then
	    if ! status=$(ejabberdctl register "$USER" "$HOST" "$PASSWD") ; then
		if echo $status | grep -q "already registered" ; then
		    echo "Admin user \"$USER@$HOST\" is already registered. Password IS NOT changed."
		else
		    echo "Can't register admin user \"$USER@$HOST\"."
		fi
	    else
		echo "Admin user \"$USER@$HOST\" is registered successfully."
	    fi
	fi
    fi
}

case "$1" in
    configure|reconfigure)
    setup_ejabberd
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 0
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

case "$1" in
    configure|reconfigure)
    register_admin
    ;;
esac

exit 0

